#!/bin/bash

scriptdir="$(dirname $0)" || exit $?
cd "$scriptdir" || exit $?
scriptdir="$PWD"

#######################################################
#      configure
#######################################################

default_prefix="$scriptdir/installed"

#######################################################
#
# We seek to have a (run in a shell):
#
#    ./configure --prefix=/Path/to/Prefix
#    make
#    make install
#
# software build and installation method via
# this file and the file GNUmakefile.
#
# And other software build and installation methods too.
#
####### NOTES ##########################################
#
# We'd like to keep configuration parameters minimized.
# It seems that the installation prefix is needed,
# but we do wish to keep the program from braking
# if the installed files move.
#######################################################


default_shabang='#!/usr/bin/env node'
shabang="$default_shabang"

function usage()
{
    local prog="$(basename $0)"

    cat << EOF

  Usage: $prog [--prefix PREFIX] [--no-compress] [--node NPATH]

  Configure the webLauncher package installation.
  
              OPTIONS
  --no-compress        do not apply yui-compressor to installed installed
                       javascript and CSS files.  The default is compress
                       if yui-compressor is found when this script runs,
                       otherwise not

  --node NPATH         set the full file path to the node (js) executable.
                       By default it $prog will set the node server script
                       to run with $default_shabang , when NPATH is set it
                       will be #!NPATH

  --prefix PREFIX      set the installation directory prefix
                       the current default PREFIX is $default_prefix


  For example in bash run:

     ./configure --prefix=/usr/local/packageXXX && make && make install


EOF
    exit 1

}

prefix=$default_prefix
if which yui-compressor > /dev/null ; then
    jscompress="yui-compressor --line-break 70 --type js"
    csscompress="yui-compressor --line-break 70 --type css"
else
    jscompress="cat"
    csscompress="cat"
fi

# yui-compressor does not work for the webLauncher nodejs code.
# uglifyjs 2.7.3 (the latest at this writing) is broken.


while [ -n "$1" ] ; do
    case "$1" in
        -*prefix)
            shift 1
            prefix="$1"
            ;;
        -*prefix=*)
            prefix="${1#*-prefix=}"
            ;;
        -*node)
            shift 1
            shabang="#!${1}"
            ;;
        -*node=*)
            shabang="#!${1#*-node=}"
            ;;
        -*no-compress)
            jscompress="cat"
            csscompress="cat"
            ;;
        *)
            usage
            ;;
    esac
    shift 1
done

echo "PREFIX=$prefix"

cat << EOF > config.make
# This was generated by running $0 $*
# $(date)

PREFIX = $prefix

jscompress = $jscompress
csscompress = $csscompress
shabang = \\$shabang

EOF

cat << EOF

  Now try running:

      make

EOF

